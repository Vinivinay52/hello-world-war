pipeline {
  agent {
    docker {
      // Image with docker CLI + git; stable-git is Alpine-based and small
      image 'docker:stable-git'
      // Mount host Docker socket and disable entrypoint so Jenkins can run `cat`
      // Also set HOME/DOCKER_CONFIG to a writable path inside the agent container
      args '-v /var/run/docker.sock:/var/run/docker.sock --entrypoint="" -e HOME=/var/jenkins_home -e DOCKER_CONFIG=/var/jenkins_home/.docker'
      reuseNode true
    }
  }

  options {
    timestamps()
    // Avoid Jenkins’ automatic “Declarative: Checkout SCM” confusion when the job is defined from SCM
    skipDefaultCheckout(true)
  }

  environment {
    // Git
    GIT_URL    = 'https://github.com/Vinivinay52/hello-world-war.git'
    GIT_BRANCH = 'master'   // <-- your repo uses master, not main

    // Docker Hub repo / image
    REPO_NAME      = 'vinay/hello-world-war'
    IMAGE_NAME     = "${REPO_NAME}"
    IMAGE_TAG      = "v${BUILD_NUMBER}"

    // Deploy target (runs on the host via the mounted docker.sock)
    CONTAINER_NAME = 'hello-world-war-container'
    HOST_PORT      = '8088'
    APP_PORT       = '8080'
  }

  stages {
    stage('Prepare agent') {
      steps {
        // Ensure the config directory exists and is writable for Docker CLI
        sh 'mkdir -p "$HOME/.docker" && chmod 700 "$HOME/.docker"'
        // docker:stable-git is Alpine; install curl for smoke test (no-op if present)
        sh 'apk add --no-cache curl >/dev/null 2>&1 || true'
        // Show where HOME points now
        sh 'echo "HOME=$HOME"; ls -ld "$HOME" "$HOME/.docker" || true'
        sh 'docker version && git --version && curl --version | head -n 1'
      }
    }

    stage('Checkout Code') {
      steps {
        git branch: env.GIT_BRANCH, url: env.GIT_URL
      }
    }

    stage('Build Docker Image') {
      steps {
        sh """
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
          docker images | head -n 10
        """
      }
    }

    stage('Login to Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'DOCKER_CREDS',   // Jenkins > Manage Credentials (global)
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
        }
      }
    }

    stage('Push Image to Docker Hub') {
      steps {
        sh "docker push ${IMAGE_NAME}:${IMAGE_TAG}"
      }
    }

    stage('Deploy Application (on master host)') {
      steps {
        sh """
          docker rm -f ${CONTAINER_NAME} 2>/dev/null || true
          docker run -d --name ${CONTAINER_NAME} -p ${HOST_PORT}:${APP_PORT} ${IMAGE_NAME}:${IMAGE_TAG}

          echo 'Waiting for app to start...'
          sleep 5
          echo 'Smoke test:'
          curl -sSf http://127.0.0.1:${HOST_PORT}/ | head -n 40 || true
        """
      }
    }
  }

  post {
    always {
      sh 'docker ps -a || true'
    }
  }
}
