pipeline {
  agent {
    docker {
      // Use a modern docker CLI image. 27+ is compatible with daemon API >=1.44.
      image 'docker:27-cli'      // or 'docker:27.2-cli' / 'docker:28-cli' / 'docker:29-cli' if available
      // Run as root to access /var/run/docker.sock; mount socket; clear entrypoint; set writable HOME
      args '-u 0:0 -v /var/run/docker.sock:/var/run/docker.sock --entrypoint="" -e HOME=/var/jenkins_home -e DOCKER_CONFIG=/var/jenkins_home/.docker'
      reuseNode true
    }
  }

  options {
    timestamps()
    skipDefaultCheckout(true)  // so only our explicit checkout runs
  }

  environment {
    // Git repo & branch
    GIT_URL    = 'https://github.com/Vinivinay52/hello-world-war.git'
    GIT_BRANCH = 'master'

    // Docker Hub repo/image
    REPO_NAME      = 'vinay/hello-world-war'
    IMAGE_NAME     = "${REPO_NAME}"
    IMAGE_TAG      = "v${BUILD_NUMBER}"

    // Deploy target on host
    CONTAINER_NAME = 'hello-world-war-container'
    HOST_PORT      = '8088'
    APP_PORT       = '8080'
  }

  stages {
    stage('Prepare agent') {
      steps {
        sh 'mkdir -p "$HOME/.docker" && chmod 700 "$HOME/.docker"'
        // Add curl for smoke test; alpine-based image
        sh 'apk add --no-cache curl >/dev/null 2>&1 || true'
        sh 'echo "HOME=$HOME"; ls -ld "$HOME" "$HOME/.docker" || true'
        sh 'docker version && git --version || true'
      }
    }

    stage('Checkout Code') {
      steps {
        git branch: env.GIT_BRANCH, url: env.GIT_URL
      }
    }

    stage('Build Docker Image') {
      steps {
        sh """
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
          docker images | head -n 10
        """
      }
    }

    stage('Login to Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'DOCKER_CREDS',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
        }
      }
    }

    stage('Push Image to Docker Hub') {
      steps {
        sh "docker push ${IMAGE_NAME}:${IMAGE_TAG}"
      }
    }

    stage('Deploy Application (on master host)') {
      steps {
        sh """
          docker rm -f ${CONTAINER_NAME} 2>/dev/null || true
          docker run -d --name ${CONTAINER_NAME} -p ${HOST_PORT}:${APP_PORT} ${IMAGE_NAME}:${IMAGE_TAG}

          echo 'Waiting for app to start...'
          sleep 5
          echo 'Smoke test:'
          curl -sSf http://127.0.0.1:${HOST_PORT}/ | head -n 40 || true
        """
      }
    }
  }

  post {
    always {
      sh 'docker ps -a || true'
    }
  }
}
